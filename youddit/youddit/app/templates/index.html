<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Youddit</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="{{ STATIC_URL }}css/bootstrap.min.css">
        <style>
            body {
                padding-top: 60px;
                padding-bottom: 40px;
            }
        </style>
        <!-- <link rel="stylesheet" href="css/bootstrap-responsive.min.css"> -->
        <link rel="stylesheet" href="{{ STATIC_URL }}css/bootstrap-responsive.css">
        <link rel="stylesheet" href="{{ STATIC_URL }}css/main.css">
        <link rel="stylesheet" href="{{ STATIC_URL }}css/jquery.thumbnailScroller.css">
        <link href='http://fonts.googleapis.com/css?family=Raleway:400,500' rel='stylesheet' type='text/css'>

   </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

        <!-- This code is taken from http://twitter.github.com/bootstrap/examples/hero.html -->
        <div class="container">
            <div class="navbar">
                <div class="navbar-inner">
                <!-- <div class="container"> -->
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="#">Youddit</a>
                    <div class="nav-collapse collapse">
                        <ul class="nav">
                            

                            
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">How it Works<b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    Info about specifying stream url, arrow keys navigation
                                </ul>
                            </li>
                            
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Popular Streams<b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    List of popular streams go here:
                                    <li><a href="#">Separated link</a></li>
                                    <li><a href="#">One more separated link</a></li>
                                </ul>
                            </li>
                            
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">Feedback<b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li class="nav-header">Email</li>
                                    <li class="divider"></li>
                                    <li class="nav-header">Feedback</li>
                                </ul>
                            </li>
                        </ul>
                    </div><!--/.nav-collapse -->
                </div>
            </div>
        </div>

        <div class="container">
            
            <div class="row" id="mainRow">
                <div class="span7" id="player"></div>
                <!-- <div id="infoRight"> -->
                <div class="span4" id="vidTitle">
                    <div id="title">Welcome!</div>
                </div> 
            </div>
            
            <div id="tS2" class="jThumbnailScroller">
                
                <div class="row">
                    <div class = "span 4 offset4">       
                        <form class="navbar-form">
                            Stream:  <input type="text" class="search-query" placeholder="videos">
                        </form>
                    </div>
                    <div class = "span 4">
                        <button id='hot' onClick="change_cat('hot')">Hot</button>
                        <button id='top' onClick="change_cat('top')">Top</button>
                        <button id='controversial' onClick="change_cat('controversial')">Controversial</button>
                        <a href = "#" onClick='prevVideo()'>Previous</a>
                        <a href = "#" onClick='nextVideo()'>Next</a>
                    </div>
                </div>
                
                <div class="jTscrollerContainer">
                    <div id='scroller' class="jTscroller">
    
                    </div>
                </div>
                <a href="#" class="jTscrollerPrevButton"></a>
                <a href="#" class="jTscrollerNextButton"></a>
            </div>


            <footer>
                <!--
                <p>&copy; name.... 2013</p>
                -->
            </footer>

        </div> <!-- /container -->
        
        <script type='text/template' id='playlist_template'>
            <a href="#" data-id=<%= id %> class="darken"><img src="http://img.youtube.com/vi/<%= vid %>/mqdefault.jpg"/><div data-id=<%= id %> class="thumbTitle"><%= title %></div></a>
        </script>


        <script src="{{ STATIC_URL }}js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
        <script src="http://www.youtube.com/player_api"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="{{ STATIC_URL }}js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
        <script src="{{ STATIC_URL }}js/vendor/bootstrap.min.js"></script>
        <script src="{{ STATIC_URL }}js/main.js"></script>



        <!-- thumbnail scroller markup end -->
		<script src="{{ STATIC_URL }}js/scroller/jquery.thumbnailScroller.js"></script>
		<script src='{{ STATIC_URL }}js/scroller/jquery.mousewheel.js' type='text/javascript'></script>
		<!-- jquery ui custom build (for animation easing) -->
		<script src="{{ STATIC_URL }}js/scroller/jquery-ui-1.8.13.custom.min.js"></script>
		<script src="{{ STATIC_URL }}js/underscore-min.js"></script>

		<script>
            
            var subreddit = "videos",
                init_data = {{ data|safe }},
                data = {}, 
                cat = 'hot', // Current category displayed
                counter = -1; // Position id of video being played now

                data['hot'] = {};
                data['hot']['videos'] = init_data['videos'];
                data['hot']['page'] = 1;
           
            function next_video() {
                return data[cat]['videos'][++counter];
            }

            function prev_video() {
                return data[cat]['videos'][--counter];
            }

            function has_next() {
                if (counter < data[cat]['videos'].length-1)
                    return true;
                else {
                    load_more();
                    return (counter < data[cat]['videos'].length-1) 
                }
            }

            function has_prev() {
                return (counter > 0);
            }

            function add_videos(v) {
                data[cat]['videos'].push(v);
            }

            function load_videos() {
                var compiled = _.template($('#playlist_template').html()),
                    video;
                for (i in data[cat]['videos']) {
                    video = data[cat]['videos'][i];
                    $('.jTscroller').append(compiled({ id: i, vid: video['vid'], title: video['title'] }))
                }
            }

            function load_more() {
                console.log("Loading more");
                $.ajax({
                    method: "GET",
                    url: "./" + subreddit, 
                    contentType: "application/json", 
                    data: {page: ++data[cat]['page'], cat: cat},
                    success: function (resp) {
                        resp = JSON.parse(resp);
                        var compiled = _.template($('#playlist_template').html()),
                            video,
                            last_id = data[cat]['videos'].length-1;
                        //$('.jTscroller').empty();
                        for (i in resp['videos']) {
                            add_videos(resp['videos'][i]);
                            video = resp['videos'][i];
                            $('.jTscroller').append(compiled({ id: ++last_id, vid: video['vid'], title: video['title'] }))
                        }
                        $(".darken").click(playListClick);
                    },
                    error: function (resp) {
                        console.log(resp);
                    }
                    });
            }

            function change_cat(newCat) {
                if (newCat == cat)
                    return false;
                else if (newCat in data) {
                     cat = newCat;
                    $('.jTscroller').css({left: 0});
                    $('.jTscroller').empty();
                     load_videos();
                }
                else {
                    cat = newCat;
                    data[cat] = {}
                    data[cat]['videos'] = [];
                    data[cat]['page'] = 0;
                    $('.jTscroller').css({left: 0});
                    $('.jTscroller').empty();
                    load_more();
                }
            }

            (function($){
            window.onload=function(){
                load_videos();

                $("#tS2").thumbnailScroller({ 
                    scrollerType:"clickButtons", 
                    scrollerOrientation:"horizontal", 
                    scrollSpeed:2, 
                    scrollEasing:"easeOutCirc", 
                    scrollEasingAmount:600, 
                    acceleration:4, 
                    scrollSpeed:800, 
                    noScrollCenterSpace:10, 
                    autoScrolling:0, 
                    autoScrollingSpeed:2000, 
                    autoScrollingEasing:"easeInOutQuad", 
                    autoScrollingDelay:500, 
                    onLast: load_more
                });

            }
            })(jQuery);

            // handle keyboard arrow key navigation
            $(document).keydown(function(e){
                switch(e.which) {
                    case 37: // left
                        prevVideo();
                        break;
        
                    case 39: // right
                        console.log('right pressed!');
                        nextVideo();
                        break;
        
                    default: return; // exit this handler for other keys
                }
                e.preventDefault();
            });
           
            // autofocus from iframe if on chrome or safari
            function keepFocused() {
                window.focus();
            }
            if (window.chrome) { 
                setInterval(keepFocused, 2000);
            }
            
            function playListClick() {
                counter = parseInt($(this).attr('data-id')-1);
                console.log(counter);
                player.stopVideo();
                var next = next_video();
                player.loadVideoById(next['vid']);
                $('#title').html(next['title']);
            }

            // create youtube player
            var player;
            function onYouTubePlayerAPIReady() {
                var first_vid = next_video();
                player = new YT.Player('player', {
                  height: '390',
                  width: '640',
                  videoId: first_vid['vid'], 
                  events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError' : onPlayerError
                  }
                });

                $('#title').html(first_vid['title']);
            }
            
            // autoplay video
            function onPlayerReady(event) {
                event.target.playVideo();
                $(".darken").click(playListClick);            
            }
        
            // check for video complete event
            function onPlayerStateChange(event) {
                if(event.data === 0) {
                    nextVideo();
                }
            }
            
            // check for video error
            function onPlayerError(event) {
                console.log("Player error, skipping video");
                nextVideo();
            }
        
            // load the next video
            function nextVideo(){
                var next;
                if (has_next()){
                    next = next_video();
                    player.stopVideo();
                    player.loadVideoById(next['vid']);
                    $('#title').html(next['title']);
                }
            }
        
            // load the previous video
            function prevVideo(){
                var next;
                if (has_prev()){
                    next = prev_video();
                    player.stopVideo();
                    player.loadVideoById(next['vid']);
                    $('#title').html(next['title']);
                }
            }
        
        </script>        
        
        <script>
            var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>
    </body>
</html>

